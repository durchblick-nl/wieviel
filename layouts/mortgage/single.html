{{ partial "head.html" . }}
{{ partial "header.html" . }}
{{ partial "page-header.html" . }}

<style>
    .mode-toggle {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .mode-btn {
        flex: 1;
        padding: 0.875rem 1rem;
        border: 2px solid var(--primary-color);
        background: var(--card-bg);
        color: var(--primary-color);
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    .mode-btn:hover {
        background: var(--light-bg);
    }
    .mode-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .input-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    @media (max-width: 500px) {
        .input-row {
            grid-template-columns: 1fr;
        }
    }

    .result-box { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 2rem; border-radius: 16px; text-align: center; margin: 1.5rem 0; }
    .result-box .label { opacity: 0.9; margin-bottom: 0.5rem; }
    .result-box .total { font-size: 2.5rem; font-weight: bold; font-family: 'Economica', sans-serif; }
    .result-box .sub { font-size: 1rem; opacity: 0.9; margin-top: 0.5rem; }
    .result-box.success { background: linear-gradient(135deg, #2e7d32, #4caf50); }
    .result-box.warning { background: linear-gradient(135deg, #f57c00, #ff9800); }
    .result-box.error { background: linear-gradient(135deg, #cc5c53, #e07a71); }

    .breakdown-card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; margin-top: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .breakdown-card h3 { color: var(--primary-color); margin-bottom: 1rem; font-size: 1.1rem; }
    .breakdown-row { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
    .breakdown-row:last-child { border-bottom: none; }
    .breakdown-row .label { color: var(--text-color); }
    .breakdown-row .value { font-weight: 600; font-family: 'Economica', sans-serif; font-size: 1.1rem; }
    .breakdown-row.total { font-weight: bold; background: var(--light-bg); margin: 0.5rem -1.5rem -1.5rem; padding: 1rem 1.5rem; border-radius: 0 0 12px 12px; }
    .breakdown-row.total .value { color: var(--primary-color); }
    .breakdown-row .value.success { color: #2e7d32; }
    .breakdown-row .value.warning { color: #f57c00; }
    .breakdown-row .value.error { color: #cc5c53; }

    .progress-bar {
        background: var(--border-color);
        border-radius: 10px;
        height: 12px;
        margin: 1rem 0;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s, background 0.3s;
    }
    .progress-fill.success { background: linear-gradient(90deg, #2e7d32, #4caf50); }
    .progress-fill.warning { background: linear-gradient(90deg, #f57c00, #ff9800); }
    .progress-fill.error { background: linear-gradient(90deg, #cc5c53, #e07a71); }

    .info-box {
        background: var(--light-bg);
        border-left: 4px solid var(--primary-color);
        padding: 1rem 1.25rem;
        border-radius: 0 8px 8px 0;
        margin: 1rem 0;
    }
    .info-box h4 {
        margin: 0 0 0.5rem 0;
        color: var(--primary-color);
        font-size: 0.95rem;
    }
    .info-box p {
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .share-buttons { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap; }
    .share-btn { padding: 0.75rem 1.25rem; border-radius: 8px; border: none; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
    .share-btn.primary { background: var(--primary-color); color: white; }
    .share-btn.copy { background: var(--secondary-color); color: white; }
    .share-btn:hover { transform: translateY(-2px); }

    .visual-breakdown {
        display: flex;
        height: 40px;
        border-radius: 8px;
        overflow: hidden;
        margin: 1rem 0;
    }
    .visual-segment {
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
        font-weight: 600;
        transition: flex 0.3s;
    }
    .visual-segment.equity { background: #2e7d32; }
    .visual-segment.mortgage1 { background: var(--primary-color); }
    .visual-segment.mortgage2 { background: var(--secondary-color); }

    .legend {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
        font-size: 0.85rem;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 3px;
    }
    .legend-dot.equity { background: #2e7d32; }
    .legend-dot.mortgage1 { background: var(--primary-color); }
    .legend-dot.mortgage2 { background: var(--secondary-color); }
</style>

<nav class="tool-nav">
    <a href="{{ "/" | relLangURL }}">{{ i18n "allTools" }}</a>
</nav>

<div class="steps-container">
    <div class="step-card">
        <div class="step-icon">
            <i class="fas fa-wallet"></i>
            <div class="step-number">1</div>
        </div>
        <div class="step-content">
            <h3>{{ i18n "mortgage.step1Title" }}</h3>
            <p>{{ i18n "mortgage.step1Desc" }}</p>
        </div>
    </div>
    <div class="step-card">
        <div class="step-icon">
            <i class="fas fa-piggy-bank"></i>
            <div class="step-number">2</div>
        </div>
        <div class="step-content">
            <h3>{{ i18n "mortgage.step2Title" }}</h3>
            <p>{{ i18n "mortgage.step2Desc" }}</p>
        </div>
    </div>
    <div class="step-card">
        <div class="step-icon">
            <i class="fas fa-home"></i>
            <div class="step-number">3</div>
        </div>
        <div class="step-content">
            <h3>{{ i18n "mortgage.step3Title" }}</h3>
            <p>{{ i18n "mortgage.step3Desc" }}</p>
        </div>
    </div>
</div>

<div class="calculator-card">
    <div class="mode-toggle">
        <button type="button" class="mode-btn active" data-mode="max-price">
            <i class="fas fa-search-dollar"></i> {{ i18n "mortgage.maxPrice" }}
        </button>
        <button type="button" class="mode-btn" data-mode="check-property">
            <i class="fas fa-clipboard-check"></i> {{ i18n "mortgage.checkProperty" }}
        </button>
    </div>

    <div id="maxPriceInputs">
        <div class="form-group">
            <label for="income">{{ i18n "mortgage.grossIncome" }}</label>
            <div style="position: relative;">
                <input type="number" id="income" value="150000" min="0" step="1000" oninput="calculate()">
                <span style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-color); opacity: 0.6;">{{ i18n "chf" }}</span>
            </div>
            <small class="form-hint">{{ i18n "mortgage.grossIncomeHint" }}</small>
        </div>

        <div class="form-group">
            <label for="equity">{{ i18n "mortgage.availableEquity" }}</label>
            <div style="position: relative;">
                <input type="number" id="equity" value="200000" min="0" step="10000" oninput="calculate()">
                <span style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-color); opacity: 0.6;">{{ i18n "chf" }}</span>
            </div>
            <small class="form-hint">{{ i18n "mortgage.equityHint" }}</small>
        </div>
    </div>

    <div id="checkPropertyInputs" style="display: none;">
        <div class="form-group">
            <label for="propertyPrice">{{ i18n "mortgage.propertyPrice" }}</label>
            <div style="position: relative;">
                <input type="number" id="propertyPrice" value="800000" min="0" step="10000" oninput="calculate()">
                <span style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-color); opacity: 0.6;">{{ i18n "chf" }}</span>
            </div>
        </div>

        <div class="input-row">
            <div class="form-group">
                <label for="income2">{{ i18n "mortgage.grossIncomeShort" }}</label>
                <div style="position: relative;">
                    <input type="number" id="income2" value="150000" min="0" step="1000" oninput="calculate()">
                    <span style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-color); opacity: 0.6;">{{ i18n "chf" }}</span>
                </div>
            </div>
            <div class="form-group">
                <label for="equity2">{{ i18n "mortgage.equity" }}</label>
                <div style="position: relative;">
                    <input type="number" id="equity2" value="200000" min="0" step="10000" oninput="calculate()">
                    <span style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-color); opacity: 0.6;">{{ i18n "chf" }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="info-box">
        <h4><i class="fas fa-info-circle"></i> {{ i18n "mortgage.calcInterestLabel" }}</h4>
        <p>{{ i18n "mortgage.calcInterestInfo" }}</p>
    </div>
</div>

<div id="results">
    <div class="result-box success" id="resultBox">
        <div class="label" id="resultLabel">{{ i18n "mortgage.maxPriceLabel" }}</div>
        <div class="total" id="mainResult">CHF 1'000'000</div>
        <div class="sub" id="resultSub">{{ i18n "mortgage.affordable" }}</div>
    </div>

    <div class="breakdown-card">
        <h3><i class="fas fa-chart-pie"></i> {{ i18n "mortgage.financingStructure" }}</h3>
        <div class="visual-breakdown" id="visualBreakdown">
            <div class="visual-segment equity" style="flex: 20;">20%</div>
            <div class="visual-segment mortgage1" style="flex: 67;">67%</div>
            <div class="visual-segment mortgage2" style="flex: 13;">13%</div>
        </div>
        <div class="legend">
            <div class="legend-item"><div class="legend-dot equity"></div> {{ i18n "mortgage.equityLabel" }}</div>
            <div class="legend-item"><div class="legend-dot mortgage1"></div> {{ i18n "mortgage.mortgage1" }}</div>
            <div class="legend-item"><div class="legend-dot mortgage2"></div> {{ i18n "mortgage.mortgage2" }}</div>
        </div>
        <div class="breakdown-row" style="margin-top: 1rem;">
            <span class="label">{{ i18n "mortgage.equityMin" }}</span>
            <span class="value" id="equityAmount">CHF 200'000</span>
        </div>
        <div class="breakdown-row">
            <span class="label">{{ i18n "mortgage.mortgage1Label" }}</span>
            <span class="value" id="mortgage1Amount">CHF 670'000</span>
        </div>
        <div class="breakdown-row">
            <span class="label">{{ i18n "mortgage.mortgage2Label" }}</span>
            <span class="value" id="mortgage2Amount">CHF 130'000</span>
        </div>
        <div class="breakdown-row total">
            <span class="label">{{ i18n "mortgage.purchasePrice" }}</span>
            <span class="value" id="totalPrice">CHF 1'000'000</span>
        </div>
    </div>

    <div class="breakdown-card">
        <h3><i class="fas fa-calculator"></i> {{ i18n "mortgage.affordabilityCalc" }}</h3>
        <div class="breakdown-row">
            <span class="label">{{ i18n "mortgage.mortgageInterest" }}</span>
            <span class="value" id="interestCost">CHF 40'000</span>
        </div>
        <div class="breakdown-row">
            <span class="label">{{ i18n "mortgage.maintenanceCosts" }}</span>
            <span class="value" id="maintenanceCost">CHF 10'000</span>
        </div>
        <div class="breakdown-row">
            <span class="label">{{ i18n "mortgage.amortization" }}</span>
            <span class="value" id="amortizationCost">CHF 8'667</span>
        </div>
        <div class="breakdown-row total">
            <span class="label">{{ i18n "mortgage.totalHousingCosts" }}</span>
            <span class="value" id="totalCost">CHF 58'667</span>
        </div>
    </div>

    <div class="breakdown-card">
        <h3><i class="fas fa-percentage"></i> {{ i18n "mortgage.affordability" }}</h3>
        <div class="breakdown-row">
            <span class="label">{{ i18n "mortgage.housingCostsIncome" }}</span>
            <span class="value" id="affordabilityPercent">32.5%</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill success" id="affordabilityBar" style="width: 32.5%;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-color); opacity: 0.7;">
            <span>0%</span>
            <span style="color: #2e7d32;">{{ i18n "mortgage.affordableBelow33" }}</span>
            <span>50%</span>
        </div>
    </div>

    <div class="breakdown-card">
        <h3><i class="fas fa-coins"></i> {{ i18n "mortgage.monthlyCosts" }}</h3>
        <div class="breakdown-row">
            <span class="label">{{ i18n "mortgage.monthlyInterest" }}</span>
            <span class="value" id="monthlyInterest">CHF 1'333</span>
        </div>
        <div class="breakdown-row">
            <span class="label">{{ i18n "mortgage.monthlyMaintenance" }}</span>
            <span class="value" id="monthlyMaintenance">CHF 833</span>
        </div>
        <div class="breakdown-row">
            <span class="label">{{ i18n "mortgage.monthlyAmortization" }}</span>
            <span class="value" id="monthlyAmortization">CHF 722</span>
        </div>
        <div class="breakdown-row total">
            <span class="label">{{ i18n "mortgage.totalPerMonth" }}</span>
            <span class="value" id="monthlyTotal">CHF 2'889</span>
        </div>
    </div>

    <div class="share-buttons">
        <button class="share-btn primary" onclick="shareResult()">
            <i class="fas fa-share-alt"></i> {{ i18n "share" }}
        </button>
        <button class="share-btn copy" onclick="copyResult()">
            <i class="fas fa-copy"></i> {{ i18n "copy" }}
        </button>
    </div>
</div>

{{ .Content }}

{{ partial "footer.html" . }}
{{ partial "darkmode.html" . }}

<script>
    // Constants
    const CALC_INTEREST_RATE = 0.05; // 5% kalkulatorischer Zinssatz
    const ACTUAL_INTEREST_RATE = 0.02; // ~2% aktueller Zinssatz
    const MAINTENANCE_RATE = 0.01; // 1% Nebenkosten
    const MAX_AFFORDABILITY = 0.33; // 33% Tragbarkeit
    const MIN_EQUITY_PERCENT = 0.20; // 20% Eigenkapital
    const FIRST_MORTGAGE_MAX = 0.67; // 67% 1. Hypothek
    const AMORTIZATION_YEARS = 15; // 15 Jahre fÃ¼r 2. Hypothek

    // State
    let mode = 'max-price';

    // i18n strings
    const i18n = {
        maxPriceLabel: {{ i18n "mortgage.maxPriceLabel" | safeJS }},
        affordable: {{ i18n "mortgage.affordable" | safeJS }},
        withYourIncomeEquity: {{ i18n "mortgage.withYourIncomeEquity" | safeJS }},
        pleaseEnterIncomeEquity: {{ i18n "mortgage.pleaseEnterIncomeEquity" | safeJS }},
        affordabilityCheck: {{ i18n "mortgage.affordabilityCheck" | safeJS }},
        notEnoughEquity: {{ i18n "mortgage.notEnoughEquity" | safeJS }},
        minimum: {{ i18n "mortgage.minimum" | safeJS }},
        needed: {{ i18n "mortgage.needed" | safeJS }},
        notAffordable: {{ i18n "mortgage.notAffordable" | safeJS }},
        ofIncome: {{ i18n "mortgage.ofIncome" | safeJS }},
        affordableLabel: {{ i18n "mortgage.affordableLabel" | safeJS }},
        perYear: {{ i18n "perYear" | safeJS }},
        purchasePrice: {{ i18n "mortgage.purchasePrice" | safeJS }},
        affordabilityPercent: {{ i18n "mortgage.affordabilityPercent" | safeJS }},
        monthlyTotal: {{ i18n "mortgage.monthlyTotal" | safeJS }},
        shareText: {{ i18n "mortgage.shareText" | safeJS }},
        shareUrl: {{ .Permalink | safeJS }},
        copied: {{ i18n "copied" | safeJS }},
        copy: {{ i18n "copy" | safeJS }}
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Mode toggle
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                mode = this.dataset.mode;
                updateInputVisibility();
                calculate();
            });
        });

        calculate();
    });

    function updateInputVisibility() {
        const maxPriceInputs = document.getElementById('maxPriceInputs');
        const checkPropertyInputs = document.getElementById('checkPropertyInputs');

        if (mode === 'max-price') {
            maxPriceInputs.style.display = 'block';
            checkPropertyInputs.style.display = 'none';
        } else {
            maxPriceInputs.style.display = 'none';
            checkPropertyInputs.style.display = 'block';
        }
    }

    function calculate() {
        let income, equity, propertyPrice;

        if (mode === 'max-price') {
            income = parseFloat(document.getElementById('income').value) || 0;
            equity = parseFloat(document.getElementById('equity').value) || 0;
            propertyPrice = calculateMaxPrice(income, equity);
        } else {
            propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 0;
            income = parseFloat(document.getElementById('income2').value) || 0;
            equity = parseFloat(document.getElementById('equity2').value) || 0;
        }

        // Calculate mortgage amounts
        const minEquityRequired = propertyPrice * MIN_EQUITY_PERCENT;
        const actualEquity = Math.min(equity, propertyPrice); // Can't use more equity than price
        const equityPercent = propertyPrice > 0 ? (actualEquity / propertyPrice) : 0;

        const totalMortgage = propertyPrice - actualEquity;
        const firstMortgageMax = propertyPrice * FIRST_MORTGAGE_MAX;
        const firstMortgage = Math.min(totalMortgage, firstMortgageMax);
        const secondMortgage = Math.max(0, totalMortgage - firstMortgage);

        // Calculate costs (kalkulatorisch)
        const interestCost = totalMortgage * CALC_INTEREST_RATE;
        const maintenanceCost = propertyPrice * MAINTENANCE_RATE;
        const amortizationCost = secondMortgage / AMORTIZATION_YEARS;
        const totalCost = interestCost + maintenanceCost + amortizationCost;

        // Calculate affordability
        const affordabilityPercent = income > 0 ? (totalCost / income) : 0;
        const isAffordable = affordabilityPercent <= MAX_AFFORDABILITY;
        const hasEnoughEquity = equity >= minEquityRequired;

        // Calculate actual monthly costs
        const monthlyInterest = (totalMortgage * ACTUAL_INTEREST_RATE) / 12;
        const monthlyMaintenance = maintenanceCost / 12;
        const monthlyAmortization = amortizationCost / 12;
        const monthlyTotal = monthlyInterest + monthlyMaintenance + monthlyAmortization;

        // Update UI
        updateResults(propertyPrice, income, equity, actualEquity, firstMortgage, secondMortgage,
                     interestCost, maintenanceCost, amortizationCost, totalCost,
                     affordabilityPercent, isAffordable, hasEnoughEquity,
                     monthlyInterest, monthlyMaintenance, monthlyAmortization, monthlyTotal,
                     equityPercent);
    }

    function calculateMaxPrice(income, equity) {
        // Two constraints:
        // 1. Equity must be >= 20% of price
        // 2. Costs must be <= 33% of income

        // Max price based on equity (price = equity / 0.20)
        const maxPriceFromEquity = equity / MIN_EQUITY_PERCENT;

        // Max price based on affordability
        // Total cost = mortgage * 5% + price * 1% + (mortgage - 67% * price) / 15 (if mortgage > 67%)
        // This is complex, so we iterate
        let maxPriceFromAffordability = 0;
        const maxAffordableCost = income * MAX_AFFORDABILITY;

        for (let price = 100000; price <= 10000000; price += 10000) {
            const mortgage = price * 0.80; // Assuming 20% equity
            const secondMort = Math.max(0, mortgage - price * FIRST_MORTGAGE_MAX);
            const cost = mortgage * CALC_INTEREST_RATE + price * MAINTENANCE_RATE + secondMort / AMORTIZATION_YEARS;

            if (cost <= maxAffordableCost) {
                maxPriceFromAffordability = price;
            } else {
                break;
            }
        }

        return Math.min(maxPriceFromEquity, maxPriceFromAffordability);
    }

    function updateResults(price, income, equity, actualEquity, mortgage1, mortgage2,
                          interestCost, maintenanceCost, amortizationCost, totalCost,
                          affordPercent, isAffordable, hasEnoughEquity,
                          monthlyInt, monthlyMaint, monthlyAmort, monthlyTotal,
                          equityPercent) {

        const resultBox = document.getElementById('resultBox');
        const resultLabel = document.getElementById('resultLabel');
        const mainResult = document.getElementById('mainResult');
        const resultSub = document.getElementById('resultSub');

        resultBox.classList.remove('success', 'warning', 'error');

        if (mode === 'max-price') {
            resultLabel.textContent = i18n.maxPriceLabel;
            mainResult.textContent = formatCHF(price);
            if (price > 0) {
                resultBox.classList.add('success');
                resultSub.textContent = i18n.withYourIncomeEquity;
            } else {
                resultBox.classList.add('error');
                resultSub.textContent = i18n.pleaseEnterIncomeEquity;
            }
        } else {
            resultLabel.textContent = i18n.affordabilityCheck;
            if (!hasEnoughEquity) {
                resultBox.classList.add('error');
                mainResult.textContent = i18n.notEnoughEquity;
                resultSub.textContent = `${i18n.minimum} ${formatCHF(price * MIN_EQUITY_PERCENT)} ${i18n.needed}`;
            } else if (!isAffordable) {
                resultBox.classList.add('warning');
                mainResult.textContent = i18n.notAffordable;
                resultSub.textContent = `${(affordPercent * 100).toFixed(1)}% > 33% ${i18n.ofIncome}`;
            } else {
                resultBox.classList.add('success');
                mainResult.textContent = i18n.affordableLabel;
                resultSub.textContent = `${(affordPercent * 100).toFixed(1)}% ${i18n.ofIncome}`;
            }
        }

        // Update visual breakdown
        const equityPct = Math.max(0, Math.min(100, equityPercent * 100));
        const mort1Pct = price > 0 ? (mortgage1 / price * 100) : 0;
        const mort2Pct = price > 0 ? (mortgage2 / price * 100) : 0;

        document.querySelector('.visual-segment.equity').style.flex = equityPct;
        document.querySelector('.visual-segment.equity').textContent = equityPct >= 10 ? Math.round(equityPct) + '%' : '';
        document.querySelector('.visual-segment.mortgage1').style.flex = mort1Pct;
        document.querySelector('.visual-segment.mortgage1').textContent = mort1Pct >= 10 ? Math.round(mort1Pct) + '%' : '';
        document.querySelector('.visual-segment.mortgage2').style.flex = mort2Pct;
        document.querySelector('.visual-segment.mortgage2').textContent = mort2Pct >= 5 ? Math.round(mort2Pct) + '%' : '';

        // Update breakdown
        document.getElementById('equityAmount').textContent = formatCHF(actualEquity);
        document.getElementById('mortgage1Amount').textContent = formatCHF(mortgage1);
        document.getElementById('mortgage2Amount').textContent = formatCHF(mortgage2);
        document.getElementById('totalPrice').textContent = formatCHF(price);

        document.getElementById('interestCost').textContent = formatCHF(interestCost) + '/' + i18n.perYear;
        document.getElementById('maintenanceCost').textContent = formatCHF(maintenanceCost) + '/' + i18n.perYear;
        document.getElementById('amortizationCost').textContent = formatCHF(amortizationCost) + '/' + i18n.perYear;
        document.getElementById('totalCost').textContent = formatCHF(totalCost) + '/' + i18n.perYear;

        // Update affordability
        const affordabilityBar = document.getElementById('affordabilityBar');
        const affordabilityPercent = document.getElementById('affordabilityPercent');
        const displayPercent = Math.min(affordPercent * 100, 50);

        affordabilityBar.style.width = (displayPercent / 50 * 100) + '%';
        affordabilityBar.classList.remove('success', 'warning', 'error');

        if (affordPercent <= 0.33) {
            affordabilityBar.classList.add('success');
            affordabilityPercent.className = 'value success';
        } else if (affordPercent <= 0.40) {
            affordabilityBar.classList.add('warning');
            affordabilityPercent.className = 'value warning';
        } else {
            affordabilityBar.classList.add('error');
            affordabilityPercent.className = 'value error';
        }
        affordabilityPercent.textContent = (affordPercent * 100).toFixed(1) + '%';

        // Update monthly costs
        document.getElementById('monthlyInterest').textContent = formatCHF(monthlyInt);
        document.getElementById('monthlyMaintenance').textContent = formatCHF(monthlyMaint);
        document.getElementById('monthlyAmortization').textContent = formatCHF(monthlyAmort);
        document.getElementById('monthlyTotal').textContent = formatCHF(monthlyTotal);
    }

    function formatCHF(amount) {
        return 'CHF ' + Math.round(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "'");
    }

    function getShareText() {
        const price = document.getElementById('totalPrice').textContent;
        const affordability = document.getElementById('affordabilityPercent').textContent;
        const monthly = document.getElementById('monthlyTotal').textContent;
        return `${i18n.shareText}\n${i18n.purchasePrice}: ${price}\n${i18n.affordability}: ${affordability}\n${i18n.monthlyTotal}: ${monthly}\n\n${i18n.shareUrl}`;
    }

    function shareResult() {
        const shareData = { title: document.title, text: getShareText(), url: window.location.href };
        if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
            navigator.share(shareData).catch(() => {});
        } else {
            window.open('https://wa.me/?text=' + encodeURIComponent(getShareText()), '_blank');
        }
    }

    function copyResult() {
        navigator.clipboard.writeText(getShareText()).then(() => {
            const btn = document.querySelector('.share-btn.copy');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> ' + i18n.copied;
            setTimeout(() => btn.innerHTML = originalText, 2000);
        });
    }
</script>

</body>
</html>
