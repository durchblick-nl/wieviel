<!DOCTYPE html>
<html lang="{{ .Site.Language.Lang }}">
<head>
    {{- partial "head.html" . }}
    <style>
        .mode-toggle { margin-bottom: 1.5rem; }
        .mode-toggle button { padding: 1rem; font-size: 0.95rem; }
        .time-input-group { display: flex; align-items: center; gap: 0.5rem; justify-content: center; margin: 1rem 0; }
        .time-input-group input[type="time"] { font-size: 2rem; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 8px; font-family: 'Economica', sans-serif; text-align: center; }
        .time-input-group input[type="time"]:focus { border-color: var(--primary-color); outline: none; }
        .now-btn { padding: 0.75rem 1.5rem; background: var(--secondary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .now-btn:hover { opacity: 0.9; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .time-card { border-radius: 12px; padding: 1.25rem; text-align: center; cursor: pointer; }
        .time-card:hover { transform: translateY(-2px); }
        .time-card .time { font-size: 1.75rem; font-weight: bold; font-family: 'Economica', sans-serif; }
        .time-card .cycles { font-size: 0.85rem; opacity: 0.8; margin-top: 0.25rem; }
        .time-card .duration { font-size: 0.9rem; margin-top: 0.5rem; }
        .time-card.recommended .badge { background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-top: 0.5rem; display: inline-block; }
        .info-text { text-align: center; color: var(--text-color); opacity: 0.8; margin-bottom: 1rem; }
        .share-buttons { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap; }
        .share-btn { padding: 0.75rem 1.25rem; border-radius: 8px; border: none; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .share-btn.primary { background: var(--primary-color); color: white; }
        .share-btn.copy { background: var(--secondary-color); color: white; }
        .share-btn:hover { transform: translateY(-2px); }
        .sleep-icon { font-size: 3rem; text-align: center; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        {{- partial "header.html" . }}
        {{- partial "page-header.html" . }}

        <div class="steps-container">
            <div class="step-card">
                <div class="step-icon"><i class="fas fa-exchange-alt"></i><div class="step-number">1</div></div>
                <div class="step-content"><h3>{{ i18n "sleep.step1Title" }}</h3><p>{{ i18n "sleep.step1Desc" }}</p></div>
            </div>
            <div class="step-card">
                <div class="step-icon"><i class="fas fa-clock"></i><div class="step-number">2</div></div>
                <div class="step-content"><h3>{{ i18n "sleep.step2Title" }}</h3><p>{{ i18n "sleep.step2Desc" }}</p></div>
            </div>
            <div class="step-card">
                <div class="step-icon"><i class="fas fa-bed"></i><div class="step-number">3</div></div>
                <div class="step-content"><h3>{{ i18n "sleep.step3Title" }}</h3><p>{{ i18n "sleep.step3Desc" }}</p></div>
            </div>
        </div>

        <div class="calculator-card">
            <div class="sleep-icon">
                <i class="fas fa-moon" style="color: var(--primary-color);"></i>
            </div>

            <div class="mode-toggle">
                <button type="button" class="active" onclick="setMode('wakeup')">
                    <i class="fas fa-sun"></i> {{ i18n "sleep.wakeUpAt" }}
                </button>
                <button type="button" onclick="setMode('sleep')">
                    <i class="fas fa-bed"></i> {{ i18n "sleep.goToSleepAt" }}
                </button>
            </div>

            <p class="info-text" id="modeDescription">{{ i18n "sleep.whenShouldYouSleep" }}</p>

            <div class="time-input-group">
                <input type="time" id="targetTime" value="07:00" onchange="calculate()">
                <button type="button" class="now-btn" onclick="setNow()" id="nowBtn" style="display: none;">
                    <i class="fas fa-clock"></i> {{ i18n "sleep.now" }}
                </button>
            </div>

            <div id="result" style="display: none;">
                <p class="info-text" id="resultDescription">{{ i18n "sleep.optimalBedtimes" }}</p>
                <div class="results-grid" id="resultsGrid"></div>

                <div class="share-buttons">
                    <button class="share-btn primary" onclick="shareResult()"><i class="fas fa-share-alt"></i> {{ i18n "share" }}</button>
                    <button class="share-btn copy" onclick="copyResult()"><i class="fas fa-copy"></i> {{ i18n "copy" }}</button>
                </div>
            </div>
        </div>

        {{ .Content }}
    </div>

    {{- partial "footer.html" . }}
    {{- partial "darkmode.html" . }}

    <script>
        const LANG = '{{ .Site.Language.Lang }}';
        const TEXTS = {
            copied: '{{ i18n "copied" }}',
            copy: '{{ i18n "copy" }}',
            whenShouldYouSleep: '{{ i18n "sleep.whenShouldYouSleep" }}',
            whenDoYouWantToSleep: '{{ i18n "sleep.whenDoYouWantToSleep" }}',
            optimalBedtimes: '{{ i18n "sleep.optimalBedtimes" }}',
            optimalWakeTimes: '{{ i18n "sleep.optimalWakeTimes" }}',
            cycles: '{{ i18n "sleep.cycles" }}',
            sleep: '{{ i18n "sleep.sleepDuration" }}',
            recommended: '{{ i18n "sleep.recommended" }}',
            shareUrl: LANG === 'de' ? 'https://wieviel.ch/schlaf/' : 'https://calcule.ch/sommeil/'
        };

        let mode = 'wakeup';
        const CYCLE_MINUTES = 90;
        const FALL_ASLEEP_MINUTES = 14;

        function setMode(m) {
            mode = m;
            document.querySelectorAll('.mode-toggle button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-toggle button:${m === 'wakeup' ? 'first' : 'last'}-child`).classList.add('active');

            if (m === 'wakeup') {
                document.getElementById('modeDescription').textContent = TEXTS.whenShouldYouSleep;
                document.getElementById('nowBtn').style.display = 'none';
                document.getElementById('targetTime').value = '07:00';
            } else {
                document.getElementById('modeDescription').textContent = TEXTS.whenDoYouWantToSleep;
                document.getElementById('nowBtn').style.display = 'inline-flex';
                setNow();
            }
            calculate();
        }

        function setNow() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('targetTime').value = `${hours}:${minutes}`;
            calculate();
        }

        function addMinutes(time, minutes) {
            const [h, m] = time.split(':').map(Number);
            const date = new Date();
            date.setHours(h, m, 0, 0);
            date.setMinutes(date.getMinutes() + minutes);
            return {
                time: `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`,
                hours: date.getHours(),
                minutes: date.getMinutes()
            };
        }

        function subtractMinutes(time, minutes) {
            return addMinutes(time, -minutes);
        }

        function formatDuration(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}min`;
        }

        function calculate() {
            const targetTime = document.getElementById('targetTime').value;
            if (!targetTime) return;

            const cycles = [6, 5, 4, 3];
            const results = [];

            if (mode === 'wakeup') {
                document.getElementById('resultDescription').textContent = TEXTS.optimalBedtimes;
                cycles.forEach(numCycles => {
                    const sleepMinutes = numCycles * CYCLE_MINUTES;
                    const totalMinutes = sleepMinutes + FALL_ASLEEP_MINUTES;
                    const bedtime = subtractMinutes(targetTime, totalMinutes);
                    results.push({
                        time: bedtime.time,
                        cycles: numCycles,
                        duration: sleepMinutes,
                        recommended: numCycles === 5 || numCycles === 6
                    });
                });
            } else {
                document.getElementById('resultDescription').textContent = TEXTS.optimalWakeTimes;
                cycles.forEach(numCycles => {
                    const sleepMinutes = numCycles * CYCLE_MINUTES;
                    const wakeTime = addMinutes(targetTime, sleepMinutes + FALL_ASLEEP_MINUTES);
                    results.push({
                        time: wakeTime.time,
                        cycles: numCycles,
                        duration: sleepMinutes,
                        recommended: numCycles === 5 || numCycles === 6
                    });
                });
            }

            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = results.map(r => `
                <div class="time-card ${r.recommended ? 'recommended' : ''}" onclick="selectTime('${r.time}', ${r.cycles})">
                    <div class="time">${r.time}</div>
                    <div class="cycles">${r.cycles} ${TEXTS.cycles}</div>
                    <div class="duration">${formatDuration(r.duration)} ${TEXTS.sleep}</div>
                    ${r.recommended ? `<div class="badge">${TEXTS.recommended}</div>` : ''}
                </div>
            `).join('');

            document.getElementById('result').style.display = 'block';
        }

        let selectedTime = null;
        let selectedCycles = null;

        function selectTime(time, cycles) {
            selectedTime = time;
            selectedCycles = cycles;
            document.querySelectorAll('.time-card').forEach(card => {
                card.style.boxShadow = card.querySelector('.time').textContent === time ? '0 0 0 3px var(--primary-color)' : 'none';
            });
        }

        function getShareText() {
            const targetTime = document.getElementById('targetTime').value;
            const description = document.getElementById('resultDescription').textContent;

            let text = mode === 'wakeup'
                ? (LANG === 'de' ? `Ich muss um ${targetTime} aufstehen.` : `Je dois me lever à ${targetTime}.`)
                : (LANG === 'de' ? `Ich gehe um ${targetTime} schlafen.` : `Je vais dormir à ${targetTime}.`);

            text += `\n\n${description}\n`;

            const cards = document.querySelectorAll('.time-card');
            cards.forEach(card => {
                const time = card.querySelector('.time').textContent;
                const cycles = card.querySelector('.cycles').textContent;
                const duration = card.querySelector('.duration').textContent;
                const isRecommended = card.classList.contains('recommended');
                text += `\n${isRecommended ? '⭐ ' : ''}${time} (${cycles}, ${duration})`;
            });

            text += `\n\n${TEXTS.shareUrl}`;
            return text;
        }

        function shareResult() {
            const shareData = { title: document.title, text: getShareText(), url: window.location.href };
            if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                navigator.share(shareData).catch(() => {});
            } else {
                window.open('https://wa.me/?text=' + encodeURIComponent(getShareText()), '_blank');
            }
        }

        function copyResult() {
            navigator.clipboard.writeText(getShareText()).then(() => {
                const btn = document.querySelector('.share-btn.copy');
                btn.innerHTML = '<i class="fas fa-check"></i> ' + TEXTS.copied;
                setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i> ' + TEXTS.copy, 2000);
            });
        }

        calculate();
    </script>
</body>
</html>
